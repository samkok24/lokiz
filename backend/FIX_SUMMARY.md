# LOKIZ API ë¬¸ì œ ìˆ˜ì • ì™„ë£Œ ë³´ê³ ì„œ

**ìˆ˜ì • ë‚ ì§œ**: 2025ë…„ 10ì›” 29ì¼

---

## ğŸ“‹ ìˆ˜ì • ì™„ë£Œ í•­ëª©

### ğŸ”´ 1ë‹¨ê³„: Critical ë¬¸ì œ (3ê°œ)

#### âœ… 1. Mock S3 í”„ë ˆì„ ìº¡ì²˜ ìˆ˜ì •
**ë¬¸ì œ**: Mock S3ê°€ ë¹ˆ íŒŒì¼ë§Œ ìƒì„±í•´ì„œ ffmpeg ì‹¤íŒ¨

**í•´ê²°**:
- 5ì´ˆ ìƒ˜í”Œ ë¹„ë””ì˜¤ ìƒì„± (`/home/ubuntu/lokiz-backend/tests/sample.mp4`)
- Mock S3 `download_file()` ë©”ì„œë“œ ìˆ˜ì •
- ìƒ˜í”Œ ë¹„ë””ì˜¤ë¥¼ ë¡œì»¬ ê²½ë¡œë¡œ ë³µì‚¬
- ffmpeg í”„ë ˆì„ ìº¡ì²˜ ì •ìƒ ì‘ë™

**íŒŒì¼**: `app/services/mock_s3_service.py`

---

#### âœ… 2. ê¸€ë¦¬ì¹˜ ì¡°íšŒ API ì¸ì¦ ì¶”ê°€
**ë¬¸ì œ**: Optional ì¸ì¦ìœ¼ë¡œ ëˆ„êµ¬ë‚˜ ë¹„ê³µê°œ ë¹„ë””ì˜¤ ì¡°íšŒ ê°€ëŠ¥

**í•´ê²°**:
- `Optional[User]` â†’ `User`ë¡œ ë³€ê²½ (í•„ìˆ˜ ì¸ì¦)
- ë¹„ê³µê°œ ë¹„ë””ì˜¤ ê¶Œí•œ ê²€ì¦ ì¶”ê°€
- ë¹„ê³µê°œ ê¸€ë¦¬ì¹˜ í•„í„°ë§
- ì›ë³¸ ë¹„ë””ì˜¤ê°€ ë¹„ê³µê°œì¸ ê²½ìš° ì •ë³´ ìˆ¨ê¹€

**íŒŒì¼**: `app/routers/glitch.py`

**ì¶”ê°€ëœ ê²€ì¦**:
```python
if video.status == "private" and video.user_id != current_user.id:
    raise HTTPException(status_code=403, detail="Access denied to private video")
```

---

#### âœ… 3. AI ì‘ì—… ì‘ë‹µì— video_id ì¶”ê°€
**ë¬¸ì œ**: ê¸€ë¦¬ì¹˜ ìƒì„± í›„ ì–´ë–¤ ë¹„ë””ì˜¤ê°€ ë§Œë“¤ì–´ì¡ŒëŠ”ì§€ ì•Œ ìˆ˜ ì—†ìŒ

**í•´ê²°**:
- `output_data`ì— `video_id` í•„ë“œ ì¶”ê°€
- ê¸€ë¦¬ì¹˜ animateì™€ replace ëª¨ë‘ ì ìš©
- í…œí”Œë¦¿ ìƒì„±ì—ë„ ì ìš©

**íŒŒì¼**: `app/routers/ai.py`

**ì‘ë‹µ ì˜ˆì‹œ**:
```json
{
  "output_data": {
    "video_url": "https://...",
    "model": "wan-video/wan-2.2-animate-animation",
    "video_id": "uuid"
  }
}
```

---

### ğŸŸ¡ 2ë‹¨ê³„: Major ë¬¸ì œ (4ê°œ)

#### âœ… 4. ìŠ¤íŠœë””ì˜¤ API ê¶Œí•œ ìˆ˜ì •
**ë¬¸ì œ**: ë‹¤ë¥¸ ì‚¬ëŒ ì˜ìƒì˜ íƒ€ì„ë¼ì¸ì„ ë³¼ ìˆ˜ ì—†ì–´ì„œ ê¸€ë¦¬ì¹˜ ì›Œí¬í”Œë¡œìš° ë¶ˆê°€ëŠ¥

**í•´ê²°**:
- ê³µê°œ ë¹„ë””ì˜¤ëŠ” ëˆ„êµ¬ë‚˜ ì¡°íšŒ ê°€ëŠ¥
- ë¹„ê³µê°œ ë¹„ë””ì˜¤ëŠ” ë³¸ì¸ë§Œ ì¡°íšŒ ê°€ëŠ¥
- í”„ë ˆì„ ìº¡ì²˜ëŠ” ë³¸ì¸ ë¹„ë””ì˜¤ë§Œ ê°€ëŠ¥ (ìœ ì§€)

**íŒŒì¼**: `app/routers/studio.py`

**ë³€ê²½ ì „**:
```python
video = db.query(Video).filter(
    Video.id == video_id,
    Video.user_id == current_user.id  # ë³¸ì¸ë§Œ
).first()
```

**ë³€ê²½ í›„**:
```python
video = db.query(Video).filter(Video.id == video_id).first()

if video.status == "private" and video.user_id != current_user.id:
    raise HTTPException(status_code=403, detail="Access denied")
```

---

#### âœ… 5. í¬ë ˆë”§ ì°¨ê° íƒ€ì´ë° ë³€ê²½
**ë¬¸ì œ**: AI ì‘ì—… ì‹¤íŒ¨ ì‹œ í¬ë ˆë”§ë§Œ ìƒê³  ê²°ê³¼ë¬¼ ëª» ë°›ìŒ

**í•´ê²°**:
- AI ì‘ì—… ì„±ê³µ í›„ì—ë§Œ í¬ë ˆë”§ ì°¨ê°
- ì‹¤íŒ¨ ì‹œ í¬ë ˆë”§ ì°¨ê° ì•ˆ í•¨ (í™˜ë¶ˆ ë¶ˆí•„ìš”)
- ëª¨ë“  AI ì—”ë“œí¬ì¸íŠ¸ì— ì ìš©

**íŒŒì¼**: `app/routers/ai.py`

**ë³€ê²½ ì „**:
```python
# ì‘ì—… ì‹œì‘ ì „ ì°¨ê°
current_user.credits -= CREDITS_REQUIRED
db.commit()

# Replicate API í˜¸ì¶œ (ì‹¤íŒ¨ ê°€ëŠ¥)
result = replicate_service.generate_glitch_animate(...)
```

**ë³€ê²½ í›„**:
```python
# Replicate API í˜¸ì¶œ
result = replicate_service.generate_glitch_animate(...)

# ì„±ê³µ ì‹œì—ë§Œ ì°¨ê°
current_user.credits -= CREDITS_REQUIRED
```

---

#### âœ… 6. ë¹„ë””ì˜¤ ìƒíƒœ ê´€ë¦¬ ê°œì„ 
**ë¬¸ì œ**: ReplicateëŠ” ë¹„ë™ê¸°ì¸ë° ì¦‰ì‹œ `completed` ìƒíƒœë¡œ ì„¤ì •

**í•´ê²°**:
- ê¸€ë¦¬ì¹˜/í…œí”Œë¦¿ ìƒì„± ì‹œ `processing` ìƒíƒœë¡œ ìƒì„±
- ë‚˜ì¤‘ì— Webhookìœ¼ë¡œ `completed`ë¡œ ë³€ê²½ ê°€ëŠ¥
- í”¼ë“œì—ì„œëŠ” `completed` ìƒíƒœë§Œ ì¡°íšŒ

**íŒŒì¼**: `app/routers/ai.py`, `app/routers/video.py`

**ë³€ê²½**:
```python
new_video = Video(
    user_id=current_user.id,
    title=f"Glitch from {template_video.title}",
    url=result['output_url'],
    s3_key=f"glitch/{ai_job.id}.mp4",
    duration=5,
    status="processing"  # completed â†’ processing
)
```

---

#### âœ… 7. í˜ì´ì§€ë„¤ì´ì…˜ ì¶”ê°€
**ë¬¸ì œ**: í”¼ë“œê°€ 20ê°œë¡œ ì œí•œë˜ê³  ë‹¤ìŒ í˜ì´ì§€ ì¡°íšŒ ë°©ë²• ë¶ˆëª…í™•

**í•´ê²°**:
- Cursor-based í˜ì´ì§€ë„¤ì´ì…˜ êµ¬í˜„
- `has_more`, `next_cursor` í•„ë“œ ì¶”ê°€
- ë¬´í•œ ìŠ¤í¬ë¡¤ ì§€ì›
- `completed` ìƒíƒœ ë¹„ë””ì˜¤ë§Œ ì¡°íšŒ

**íŒŒì¼**: `app/routers/video.py`, `app/schemas/video.py`

**ì‘ë‹µ ì˜ˆì‹œ**:
```json
{
  "videos": [...],
  "total": 100,
  "page": 1,
  "page_size": 20,
  "has_more": true,
  "next_cursor": "2025-10-29T12:34:56.789Z"
}
```

**ì‚¬ìš© ë°©ë²•**:
```
GET /v1/videos/?page_size=20
GET /v1/videos/?cursor=2025-10-29T12:34:56.789Z&page_size=20
```

---

### ğŸŸ¢ 3ë‹¨ê³„: Minor ë¬¸ì œ (3ê°œ)

#### âœ… 8. Duration ê²€ì¦ ì¶”ê°€
**ë¬¸ì œ**: ì‚¬ìš©ìê°€ 100ì´ˆë¥¼ ì…ë ¥í•´ë„ í†µê³¼

**í•´ê²°**:
- Pydantic validator ì¶”ê°€
- 5 â‰¤ duration â‰¤ 10 ê²€ì¦

**íŒŒì¼**: `app/schemas/ai_job.py`

```python
@validator('duration')
def validate_duration(cls, v):
    if not 5 <= v <= 10:
        raise ValueError('Duration must be between 5 and 10 seconds')
    return v
```

---

#### âœ… 9. ë¹„ë””ì˜¤ ì‚­ì œ ì‹œ ê¸€ë¦¬ì¹˜ ê²½ê³ 
**ë¬¸ì œ**: ë¹„ë””ì˜¤ ì‚­ì œ ì‹œ ê¸€ë¦¬ì¹˜ë„ ì‚­ì œë˜ì§€ë§Œ ê²½ê³  ì—†ìŒ

**í•´ê²°**:
- ì‚­ì œ ì „ ê¸€ë¦¬ì¹˜ ê°œìˆ˜ í™•ì¸
- ì‘ë‹µ ë©”ì‹œì§€ì— ê¸€ë¦¬ì¹˜ ê°œìˆ˜ í¬í•¨
- CASCADEë¡œ ìë™ ì‚­ì œ

**íŒŒì¼**: `app/routers/video.py`

**ì‘ë‹µ ì˜ˆì‹œ**:
```json
{
  "message": "Video deleted successfully (42 glitch(es) also deleted)",
  "glitches_deleted": 42
}
```

---

#### âœ… 10. ì˜¤ë¥˜ ë©”ì‹œì§€ ê°œì„ 
**ë¬¸ì œ**: ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ë¶ˆì¹œì ˆí•¨

**í•´ê²°**:
- ìŠ¤íŠœë””ì˜¤ êµ¬ê°„ ì„ íƒ ì˜¤ë¥˜ ë©”ì‹œì§€ í•œê¸€í™”
- êµ¬ì²´ì ì¸ ê°’ í‘œì‹œ

**íŒŒì¼**: `app/routers/studio.py`

**ë³€ê²½ ì „**:
```python
detail="Selected range exceeds 10 second limit for AI processing"
```

**ë³€ê²½ í›„**:
```python
detail=f"AI ì²˜ë¦¬ëŠ” ìµœëŒ€ 10ì´ˆê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤. í˜„ì¬ ì„ íƒ: {duration:.1f}ì´ˆ"
```

---

## ğŸ“Š ìˆ˜ì • í†µê³„

### ìˆ˜ì •ëœ íŒŒì¼ (9ê°œ)
1. `app/services/mock_s3_service.py` - Mock S3 ìƒ˜í”Œ ë¹„ë””ì˜¤
2. `app/routers/glitch.py` - ì¸ì¦ ë° ê¶Œí•œ ê²€ì¦
3. `app/routers/ai.py` - í¬ë ˆë”§ íƒ€ì´ë°, ë¹„ë””ì˜¤ ìƒíƒœ, video_id
4. `app/routers/studio.py` - ê¶Œí•œ ìˆ˜ì •, ì˜¤ë¥˜ ë©”ì‹œì§€
5. `app/routers/video.py` - í˜ì´ì§€ë„¤ì´ì…˜, ì‚­ì œ ê²½ê³ 
6. `app/schemas/video.py` - í˜ì´ì§€ë„¤ì´ì…˜ ì‘ë‹µ
7. `app/schemas/ai_job.py` - Duration ê²€ì¦
8. `tests/sample.mp4` - ìƒ˜í”Œ ë¹„ë””ì˜¤ íŒŒì¼ (ìƒˆë¡œ ìƒì„±)
9. `FIX_SUMMARY.md` - ìˆ˜ì • ìš”ì•½ ë¬¸ì„œ (ìƒˆë¡œ ìƒì„±)

### ì½”ë“œ ë³€ê²½ í†µê³„
- ì¶”ê°€ëœ ì¤„: ~200 ì¤„
- ìˆ˜ì •ëœ ì¤„: ~150 ì¤„
- ì‚­ì œëœ ì¤„: ~50 ì¤„

### Lint ê²€ì‚¬
- âœ… flake8 ê²€ì‚¬ í†µê³¼ (0ê°œ ì˜¤ë¥˜)
- âœ… ë„¤ì´ë° ê·œì¹™ ì¤€ìˆ˜
- âœ… íƒ€ì… íŒíŒ… ì™„ë£Œ

---

## ğŸ¯ ìˆ˜ì • íš¨ê³¼

### ìœ ì € ê²½í—˜ ê°œì„ 
1. **ê¸€ë¦¬ì¹˜ ì›Œí¬í”Œë¡œìš° ì™„ì„±**
   - ë‹¤ë¥¸ ì‚¬ëŒ ì˜ìƒìœ¼ë¡œ ê¸€ë¦¬ì¹˜ ìƒì„± ê°€ëŠ¥
   - í”„ë ˆì„ ìº¡ì²˜ ì •ìƒ ì‘ë™
   - ìƒì„±ëœ ë¹„ë””ì˜¤ ID í™•ì¸ ê°€ëŠ¥

2. **í¬ë ˆë”§ ë³´í˜¸**
   - AI ì‹¤íŒ¨ ì‹œ í¬ë ˆë”§ ì†ì‹¤ ì—†ìŒ
   - ê³µì •í•œ ê³¼ê¸ˆ ì‹œìŠ¤í…œ

3. **ë¬´í•œ ìŠ¤í¬ë¡¤ ì§€ì›**
   - í”¼ë“œì—ì„œ ëª¨ë“  ë¹„ë””ì˜¤ ì¡°íšŒ ê°€ëŠ¥
   - ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ ê²½í—˜

### ë³´ì•ˆ ê°•í™”
1. **ì¸ì¦ í•„ìˆ˜í™”**
   - ëª¨ë“  ê¸€ë¦¬ì¹˜ ì¡°íšŒ API ì¸ì¦ í•„ìš”
   - ë¹„ê³µê°œ ë¹„ë””ì˜¤ ì •ë³´ ë³´í˜¸

2. **ê¶Œí•œ ê²€ì¦**
   - ê³µê°œ/ë¹„ê³µê°œ ë¹„ë””ì˜¤ êµ¬ë¶„
   - ë³¸ì¸ ë¹„ë””ì˜¤ë§Œ í¸ì§‘ ê°€ëŠ¥

### ë°ì´í„° ì¼ê´€ì„±
1. **ë¹„ë””ì˜¤ ìƒíƒœ ê´€ë¦¬**
   - `processing` â†’ `completed` ìƒíƒœ ì „í™˜
   - Webhook ì¤€ë¹„ ì™„ë£Œ

2. **ê¸€ë¦¬ì¹˜ ê´€ê³„ ì¶”ì **
   - ì‚­ì œ ì‹œ CASCADE ì²˜ë¦¬
   - ì‚¬ìš©ìì—ê²Œ ê²½ê³  ë©”ì‹œì§€

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

### ì¶”ê°€ ê°œì„  ê¶Œì¥ ì‚¬í•­

1. **Webhook êµ¬í˜„**
   - Replicate Webhook ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
   - ë¹„ë””ì˜¤ ìƒíƒœ ìë™ ì—…ë°ì´íŠ¸
   - ì‚¬ìš©ì ì•Œë¦¼

2. **í†µí•© í…ŒìŠ¤íŠ¸**
   - ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸
   - API í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„±

3. **API ë¬¸ì„œ ì—…ë°ì´íŠ¸**
   - OpenAPI ìŠ¤í™ ì—…ë°ì´íŠ¸
   - ì˜ˆì œ ì½”ë“œ ì¶”ê°€

4. **ëª¨ë‹ˆí„°ë§**
   - í¬ë ˆë”§ ì‚¬ìš©ëŸ‰ ì¶”ì 
   - AI ì‘ì—… ì‹¤íŒ¨ìœ¨ ëª¨ë‹ˆí„°ë§

---

## âœ… ê²€ìˆ˜ í†µê³¼

- âœ… API í†µì‹  ì •ìƒ
- âœ… API ì„¤ê³„ ì¼ê´€ì„±
- âœ… ë°ì´í„° ì¼ê´€ì„±
- âœ… ìœ ì € ê²½í—˜ ê°œì„ 
- âœ… ë³´ì•ˆ ê°•í™”
- âœ… Lint ê²€ì‚¬ í†µê³¼

---

## ğŸ“ ê²°ë¡ 

ì´ **10ê°œì˜ ë¬¸ì œ**ë¥¼ ëª¨ë‘ ìˆ˜ì • ì™„ë£Œí–ˆìŠµë‹ˆë‹¤:
- ğŸ”´ Critical: 3ê°œ
- ğŸŸ¡ Major: 4ê°œ
- ğŸŸ¢ Minor: 3ê°œ

ëª¨ë“  ìˆ˜ì • ì‚¬í•­ì€ flake8 ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìœ¼ë©°, ê¸°ì¡´ ê¸°ëŠ¥ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì´ì œ Phase 4 (ì†Œì…œ ê¸°ëŠ¥ API)ë¡œ ì§„í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤!


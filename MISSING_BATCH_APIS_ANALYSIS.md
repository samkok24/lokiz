# 누락된 배치 API 심층 분석

**분석 기준:** 서비스 기획서 + 현재 코드베이스 대조

---

## 🔍 분석 방법론

1. **기획서 검토**: 사용자 플로우, 소셜 기능, 프로필 페이지 요구사항
2. **코드베이스 검토**: 현재 구현된 API 엔드포인트 52개 분석
3. **사용자 시나리오 매핑**: 실제 사용 시 필요한 데이터 흐름 추적
4. **N+1 쿼리 문제 식별**: 반복적인 개별 요청이 발생하는 지점 찾기

---

## 🚨 즉시 필요한 배치 API (5개)

### 1. 댓글 배치 조회 API ⚠️ CRITICAL

**문제:**
- 현재: 영상 상세 페이지에서 댓글 목록만 조회 가능
- 누락: 각 댓글 작성자의 팔로우 상태를 확인하려면 N번의 개별 요청 필요

**시나리오:**
```
사용자가 영상 상세 페이지를 열면:
1. 영상 정보 조회: 1번
2. 댓글 목록 조회: 1번 (20개 댓글)
3. 각 댓글 작성자의 팔로우 상태 확인: 20번 ❌
= 총 22번의 API 요청
```

**해결책:**
```
POST /v1/comments/batch-info
```

**요청:**
```json
{
  "comment_ids": ["uuid1", "uuid2", ...]
}
```

**응답:**
```json
{
  "comments": {
    "uuid1": {
      "user": {
        "id": "user_uuid",
        "username": "john_doe",
        "profile_image_url": "...",
        "is_following": true
      },
      "like_count": 12,
      "is_liked": false
    }
  }
}
```

**개선 효과:** 22번 → 3번 (86% 감소)

---

### 2. 해시태그 배치 조회 API ⚠️ HIGH

**문제:**
- 현재: 트렌딩 해시태그 목록만 조회 가능
- 누락: 각 해시태그의 영상 수, 조회수 합계 등 통계를 개별 조회해야 함

**시나리오:**
```
트렌딩 페이지 로딩:
1. 트렌딩 해시태그 목록: 1번 (20개)
2. 각 해시태그의 영상 수: 20번 ❌
3. 각 해시태그의 최신 썸네일: 20번 ❌
= 총 41번의 API 요청
```

**해결책:**
```
POST /v1/hashtags/batch-stats
```

**요청:**
```json
{
  "hashtag_names": ["dance", "funny", "ai", ...]
}
```

**응답:**
```json
{
  "hashtags": {
    "dance": {
      "video_count": 1234,
      "total_views": 567890,
      "latest_thumbnail": "https://...",
      "trending_score": 95.2
    }
  }
}
```

**개선 효과:** 41번 → 2번 (95% 감소)

---

### 3. 사용자 배치 정보 조회 API ⚠️ HIGH

**문제:**
- 현재: 팔로우 배치 확인만 가능
- 누락: 여러 사용자의 프로필 정보(팔로워 수, 영상 수 등)를 한 번에 조회 불가

**시나리오:**
```
사용자 검색 결과 페이지:
1. 사용자 검색: 1번 (20명)
2. 각 사용자의 팔로우 상태: 1번 (배치 API 사용) ✅
3. 각 사용자의 팔로워 수: 20번 ❌
4. 각 사용자의 영상 수: 20번 ❌
= 총 42번의 API 요청
```

**해결책:**
```
POST /v1/users/batch-info
```

**요청:**
```json
{
  "user_ids": ["uuid1", "uuid2", ...]
}
```

**응답:**
```json
{
  "users": {
    "uuid1": {
      "username": "john_doe",
      "display_name": "John Doe",
      "profile_image_url": "...",
      "bio": "...",
      "follower_count": 1234,
      "following_count": 567,
      "video_count": 89,
      "is_following": true,
      "is_verified": false
    }
  }
}
```

**개선 효과:** 42번 → 2번 (95% 감소)

---

### 4. 리믹스 체인 배치 조회 API ⚠️ MEDIUM

**문제:**
- 현재: 개별 영상의 리믹스 목록만 조회 가능
- 누락: 여러 영상의 리믹스 관계를 한 번에 조회 불가
- 기획서 핵심: "리믹스 비율"이 핵심 KPI

**시나리오:**
```
프로필 페이지 - 내 영상 탭:
1. 내 영상 목록: 1번 (20개)
2. 각 영상이 리믹스된 횟수: 20번 ❌
3. 각 영상의 원본 정보 (리믹스인 경우): 20번 ❌
= 총 41번의 API 요청
```

**해결책:**
```
POST /v1/videos/batch-remix-info
```

**요청:**
```json
{
  "video_ids": ["uuid1", "uuid2", ...]
}
```

**응답:**
```json
{
  "videos": {
    "uuid1": {
      "is_remix": true,
      "original_video": {
        "id": "original_uuid",
        "user": {
          "id": "user_uuid",
          "username": "original_creator"
        },
        "thumbnail_url": "..."
      },
      "remix_count": 15,
      "latest_remixes": [
        {
          "id": "remix_uuid",
          "thumbnail_url": "...",
          "user": { "username": "remixer" }
        }
      ]
    }
  }
}
```

**개선 효과:** 41번 → 2번 (95% 감소)

---

### 5. 글리치 배치 정보 조회 API ⚠️ MEDIUM

**문제:**
- 현재: 개별 영상의 글리치 목록만 조회 가능
- 누락: 여러 영상의 글리치 정보를 한 번에 조회 불가
- 기획서 핵심: 글리치는 WAN 2.2 기반 핵심 기능

**시나리오:**
```
피드 로딩 시:
1. 피드 영상 목록: 1번 (20개)
2. 각 영상의 글리치 수: 이미 video.glitch_count에 포함 ✅
3. 각 영상의 최신 글리치 썸네일: 20번 ❌
= 총 21번의 API 요청
```

**해결책:**
```
POST /v1/glitch/batch-info
```

**요청:**
```json
{
  "video_ids": ["uuid1", "uuid2", ...]
}
```

**응답:**
```json
{
  "videos": {
    "uuid1": {
      "glitch_count": 8,
      "latest_glitches": [
        {
          "id": "glitch_uuid",
          "thumbnail_url": "...",
          "glitch_type": "animate",
          "user": { "username": "glitcher" }
        }
      ]
    }
  }
}
```

**개선 효과:** 21번 → 2번 (90% 감소)

---

## 🟡 선택적 배치 API (4개)

### 6. 영상 배치 업로드 상태 확인 API

**문제:**
- 사용자가 여러 영상을 동시에 업로드할 때 각각의 상태를 확인해야 함

**해결책:**
```
POST /v1/videos/batch-upload-status
```

**사용 시나리오:**
- 사용자가 5개 영상을 동시 업로드
- 2초마다 모든 영상의 업로드 진행률 확인

---

### 7. 알림 배치 상세 정보 조회 API

**문제:**
- 현재: 알림 목록만 조회 가능
- 누락: 각 알림의 관련 사용자/영상 정보를 개별 조회해야 함

**해결책:**
```
POST /v1/notifications/batch-details
```

**응답:**
```json
{
  "notifications": {
    "uuid1": {
      "type": "like",
      "actor": {
        "id": "user_uuid",
        "username": "john_doe",
        "profile_image_url": "..."
      },
      "target_video": {
        "id": "video_uuid",
        "thumbnail_url": "..."
      },
      "is_read": false,
      "created_at": "2025-10-29T12:00:00Z"
    }
  }
}
```

---

### 8. 검색 결과 배치 강화 정보 API

**문제:**
- 검색 결과에 추가 정보(팔로우 상태, 좋아요 상태 등)를 붙이려면 여러 배치 API를 호출해야 함

**해결책:**
```
POST /v1/search/batch-enrich
```

**요청:**
```json
{
  "video_ids": [...],
  "user_ids": [...]
}
```

**응답:**
- 영상 메타데이터 + 좋아요 상태
- 사용자 정보 + 팔로우 상태
- 한 번의 요청으로 모든 정보 반환

---

### 9. 크레딧 사용 내역 배치 조회 API

**문제:**
- 여러 트랜잭션의 상세 정보를 개별 조회해야 함

**해결책:**
```
POST /v1/credits/transactions/batch-details
```

**사용 시나리오:**
- 크레딧 사용 내역 페이지에서 각 트랜잭션의 관련 영상/AI 작업 정보 표시

---

## 📊 우선순위 매트릭스

| API | 중요도 | 영향도 | 구현 난이도 | 우선순위 |
|-----|--------|--------|-------------|----------|
| 1. 댓글 배치 조회 | ⚠️ CRITICAL | 매우 높음 | 중간 | **1순위** |
| 2. 해시태그 배치 통계 | ⚠️ HIGH | 높음 | 낮음 | **2순위** |
| 3. 사용자 배치 정보 | ⚠️ HIGH | 높음 | 중간 | **3순위** |
| 4. 리믹스 체인 배치 | ⚠️ MEDIUM | 중간 | 높음 | **4순위** |
| 5. 글리치 배치 정보 | ⚠️ MEDIUM | 중간 | 중간 | **5순위** |
| 6. 영상 업로드 상태 | 🟡 LOW | 낮음 | 낮음 | 6순위 |
| 7. 알림 상세 정보 | 🟡 LOW | 낮음 | 중간 | 7순위 |
| 8. 검색 결과 강화 | 🟡 LOW | 낮음 | 높음 | 8순위 |
| 9. 크레딧 내역 상세 | 🟡 LOW | 낮음 | 낮음 | 9순위 |

---

## 🎯 구현 로드맵

### Phase 1: 소셜 기능 최적화 (1-2일)
1. ✅ 댓글 배치 조회 API
2. ✅ 사용자 배치 정보 API

**목표:** 영상 상세 페이지, 사용자 검색 성능 개선

---

### Phase 2: 트렌딩 및 발견 최적화 (1일)
3. ✅ 해시태그 배치 통계 API

**목표:** 트렌딩 페이지, 해시태그 페이지 성능 개선

---

### Phase 3: 리믹스 생태계 최적화 (2-3일)
4. ✅ 리믹스 체인 배치 조회 API
5. ✅ 글리치 배치 정보 API

**목표:** 리믹스 관계 시각화, 글리치 갤러리 성능 개선

---

### Phase 4: 선택적 기능 (추후)
6-9. 필요 시 구현

---

## 💡 추가 발견 사항

### 1. 댓글에 좋아요 기능 누락

**기획서 확인:**
- 댓글 좋아요 기능은 명시되지 않았지만, 일반적인 소셜 플랫폼에서는 필수

**제안:**
- `comment_like_count` 필드 추가
- `POST /v1/comments/{comment_id}/like` API 추가
- 댓글 배치 조회 API에 좋아요 상태 포함

---

### 2. 영상 공유 기능 누락

**기획서 확인:**
- "소셜 기능 - 좋아요, 댓글, 공유" 명시됨
- 현재 공유 API 없음

**제안:**
- `share_count` 필드 추가
- `POST /v1/videos/{video_id}/share` API 추가
- 공유 시 알림 생성

---

### 3. 북마크/저장 기능 누락

**기획서 확인:**
- 명시되지 않았지만, 사용자 경험상 필요

**제안:**
- `bookmarks` 테이블 추가
- `POST /v1/bookmarks/videos/{video_id}` API 추가
- 프로필에 "저장한 영상" 탭 추가

---

## 📈 전체 성능 개선 예상치

### Before (배치 API 없음)
```
피드 20개 영상 로딩:
- 피드 조회: 1번
- 영상 통계: 20번
- 좋아요 상태: 20번
- 팔로우 상태: 20번
- 리믹스 정보: 20번
- 글리치 정보: 20번
= 총 101번의 API 요청
```

### After (모든 배치 API 구현)
```
피드 20개 영상 로딩:
- 피드 조회: 1번
- 배치 API 5개: 5번
= 총 6번의 API 요청
```

**개선율: 94% 요청 감소 (101번 → 6번)**

---

## 🚀 즉시 구현 권장

**TOP 3:**
1. **댓글 배치 조회 API** - 영상 상세 페이지 필수
2. **사용자 배치 정보 API** - 검색, 팔로워 목록 필수
3. **해시태그 배치 통계 API** - 트렌딩 페이지 필수

이 3개만 구현해도 **주요 페이지의 API 요청을 80-90% 감소**시킬 수 있습니다.

